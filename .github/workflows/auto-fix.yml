name: Auto Fix

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  check_run:
    types: [completed]

permissions: {}

jobs:
  check-and-trigger:
    if: |
      (
        (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
        (github.event.comment.user.login == 'greptile-apps[bot]' ||
         github.event.comment.user.login == 'coderabbitai[bot]') &&
        (github.event.issue.pull_request != null || github.event.pull_request != null)
      ) || (
        github.event_name == 'check_run' &&
        github.event.check_run.conclusion == 'failure' &&
        github.event.check_run.pull_requests[0] != null &&
        (
          github.event.check_run.name == 'lint' ||
          github.event.check_run.name == 'build' ||
          github.event.check_run.name == 'unit-test' ||
          github.event.check_run.name == 'integration-test' ||
          github.event.check_run.name == 'e2e-test'
        )
      )
    runs-on: [self-hosted, Linux, X64]
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Fork safety guard
        id: fork-check
        uses: actions/github-script@v8
        with:
          script: |
            async function getPR(prNumber) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              return pr;
            }

            if (context.eventName === 'pull_request_review_comment') {
              const headRepo = context.payload.pull_request.head.repo.full_name;
              const baseRepo = context.payload.pull_request.base.repo.full_name;
              if (headRepo !== baseRepo) {
                core.setFailed(`Skipping auto-fix: fork PR (${headRepo} != ${baseRepo})`);
                return;
              }
            }

            if (context.eventName === 'issue_comment') {
              const pr = await getPR(context.payload.issue.number);
              if (pr.head.repo.full_name !== pr.base.repo.full_name) {
                // Never auto-fix fork PRs — the fork branch is untrusted code
                core.setFailed(`Skipping auto-fix: fork PRs are not eligible (${pr.head.repo.full_name})`);
                return;
              }
            }

            if (context.eventName === 'check_run') {
              const pr = await getPR(context.payload.check_run.pull_requests[0].number);
              if (pr.head.repo.full_name !== pr.base.repo.full_name) {
                core.setFailed(`Skipping auto-fix: fork PR (${pr.head.repo.full_name})`);
                return;
              }
            }

            core.setOutput('safe', 'true');
            core.info('Fork safety check passed — same-repo PR');

      - name: Get PR number and event context
        id: ctx
        uses: actions/github-script@v8
        with:
          script: |
            let prNumber, failedCheck;
            if (context.eventName === 'check_run') {
              prNumber = context.payload.check_run.pull_requests[0].number;
              failedCheck = context.payload.check_run.name;
            } else if (context.eventName === 'pull_request_review_comment') {
              prNumber = context.payload.pull_request.number;
            } else {
              prNumber = context.payload.issue.number;
            }
            core.setOutput('pr_number', String(prNumber));
            core.setOutput('is_ci_failure', context.eventName === 'check_run' ? 'true' : 'false');
            core.setOutput('failed_check', failedCheck || '');

      - name: Check for auto-fixing label
        id: label-check
        uses: actions/github-script@v8
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.ctx.outputs.pr_number }}'),
            });
            core.setOutput('skip', labels.some(l => l.name === 'auto-fixing') ? 'true' : 'false');

      - name: Add auto-fixing label
        if: steps.label-check.outputs.skip == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.ctx.outputs.pr_number }}'),
              labels: ['auto-fixing'],
            });

      - name: Wait for other reviewers (reviewer events only)
        if: steps.label-check.outputs.skip == 'false' && steps.ctx.outputs.is_ci_failure == 'false'
        run: sleep 180

      - name: Get PR branch
        id: pr-info
        if: steps.label-check.outputs.skip == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ steps.ctx.outputs.pr_number }}'),
            });
            core.setOutput('head_ref', pr.head.ref);

      - uses: actions/checkout@v6
        if: steps.label-check.outputs.skip == 'false' && steps.fork-check.outputs.safe == 'true'
        with:
          ref: ${{ steps.pr-info.outputs.head_ref }}
          fetch-depth: 0

      - name: Claude auto-fix (reviewer feedback)
        if: steps.label-check.outputs.skip == 'false' && steps.ctx.outputs.is_ci_failure == 'false'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          path_to_claude_code_executable: /home/runner/.local/bin/claude
          claude_args: "--model claude-sonnet-4-6 --dangerously-skip-permissions"
          allowed_bots: '*'
          prompt: |
            You are fixing issues flagged by automated code reviewers on PR #${{ steps.ctx.outputs.pr_number }} in ${{ github.repository }}.

            Steps:
            1. Read every comment from greptile-apps[bot] and coderabbitai[bot] on this PR
            2. Fix every issue they flagged — bugs, security concerns, TypeScript issues, missing error handling, test gaps
            3. Commit and push fixes to this branch
            4. Remove the auto-fixing label: gh issue edit ${{ steps.ctx.outputs.pr_number }} --remove-label auto-fixing --repo ${{ github.repository }}
            5. Queue for merge: gh pr merge --auto --squash --repo ${{ github.repository }} ${{ steps.ctx.outputs.pr_number }}

            Do not skip flagged issues. Fix everything or leave a clear PR comment explaining why it does not apply.

      - name: Claude auto-fix (CI failure)
        if: steps.label-check.outputs.skip == 'false' && steps.ctx.outputs.is_ci_failure == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          path_to_claude_code_executable: /home/runner/.local/bin/claude
          claude_args: "--model claude-sonnet-4-6 --dangerously-skip-permissions"
          allowed_bots: '*'
          prompt: |
            The CI check "${{ steps.ctx.outputs.failed_check }}" is failing on PR #${{ steps.ctx.outputs.pr_number }} in ${{ github.repository }}.

            Steps:
            1. Run the failing check locally to see exact errors (lint, type check, tests, or build)
            2. Fix every failing error — do not suppress, do not skip
            3. Commit and push fixes to this branch
            4. Remove the auto-fixing label: gh issue edit ${{ steps.ctx.outputs.pr_number }} --remove-label auto-fixing --repo ${{ github.repository }}
            5. Once CI passes, queue for merge: gh pr merge --auto --squash --repo ${{ github.repository }} ${{ steps.ctx.outputs.pr_number }}

            Focus on the "${{ steps.ctx.outputs.failed_check }}" failure. Fix the root cause.

      - name: Remove auto-fixing label (cleanup)
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt('${{ steps.ctx.outputs.pr_number }}'),
                name: 'auto-fixing',
              });
            } catch (e) { /* already removed by Claude */ }
