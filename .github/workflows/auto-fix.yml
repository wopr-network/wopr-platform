name: Auto Fix

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  check-and-trigger:
    # Only fire when greptile or coderabbit post a comment on a PR
    if: |
      (github.event.comment.user.login == 'greptile-apps[bot]' ||
       github.event.comment.user.login == 'coderabbitai[bot]') &&
      github.event.issue.pull_request != null
    runs-on: [self-hosted, Linux, X64]
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      should_fix: ${{ steps.check.outputs.should_fix }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check if both reviewers have weighed in
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            core.setOutput('pr_number', pr_number);

            // Check for auto-fixing label — skip if Claude is already working
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
            });
            if (labels.some(l => l.name === 'auto-fixing')) {
              console.log('auto-fixing label present, skipping');
              core.setOutput('should_fix', 'false');
              return;
            }

            // Fetch all PR comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              per_page: 100,
            });

            const hasGreptile = comments.some(c => c.user.login === 'greptile-apps[bot]');
            const hasCodeRabbit = comments.some(c => c.user.login === 'coderabbitai[bot]');

            console.log(`greptile: ${hasGreptile}, coderabbit: ${hasCodeRabbit}`);

            if (hasGreptile && hasCodeRabbit) {
              core.setOutput('should_fix', 'true');
            } else {
              core.setOutput('should_fix', 'false');
            }

      - name: Add auto-fixing label
        if: steps.check.outputs.should_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.check.outputs.pr_number }},
              labels: ['auto-fixing'],
            });

      - name: Trigger Claude to fix all review feedback
        if: steps.check.outputs.should_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.check.outputs.pr_number }},
              body: `@claude Please fix all issues raised by the reviewers on this PR.

            Steps:
            1. Read every comment from \`greptile-apps[bot]\` and \`coderabbitai[bot]\` on this PR
            2. Fix every issue they flagged — bugs, security concerns, TypeScript issues, missing error handling, test gaps
            3. Commit and push fixes to this branch
            4. Remove the \`auto-fixing\` label from this PR
            5. Run \`gh pr merge --auto --squash --repo ${{ github.repository }} ${{ steps.check.outputs.pr_number }}\` to queue it for merge

            Do not skip issues. If a reviewer flags something, fix it or leave a clear explanation as a PR comment.`,
            });
